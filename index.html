<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CES 2026 åœ°å›³æ©Ÿèƒ½ - Step 2</title>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Papa Parse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f1e8;
            color: #5d4e37;
        }
        
        .header {
            background: #a8c686;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .controls {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e8dcc8;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .stat-item {
            font-size: 0.9rem;
        }
        
        .stat-item strong {
            color: #7ea355;
        }
        
        .search-box {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e8dcc8;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        #map {
            width: 100%;
            height: calc(100vh - 180px);
            min-height: 400px;
            background: white;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }
        
        .loading.hidden {
            display: none;
        }
        
        /* Leaflet ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        
        .leaflet-popup-content {
            margin: 12px;
            min-width: 200px;
        }
        
        .popup-title {
            font-weight: bold;
            color: #5d4e37;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #e8dcc8;
            padding-bottom: 0.5rem;
        }
        
        .popup-info {
            font-size: 0.85rem;
            color: #8b7d6b;
            margin: 0.25rem 0;
        }
        
        .popup-booth {
            display: inline-block;
            background: #a8c686;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .popup-badges {
            margin-top: 0.5rem;
        }
        
        .popup-badge {
            display: inline-block;
            background: #ffd89b;
            color: #8b5a3c;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        
        .popup-badge.best {
            background: #ffd89b;
        }
        
        .popup-badge.yamanaka {
            background: #e8dcc8;
        }
        
        .popup-badge.nagasaka {
            background: #e8dcc8;
        }
        
        /* ãƒ”ãƒ³ã®è‰²åˆ†ã‘ç”¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ */
        .custom-marker {
            background: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            border-radius: 4px;
            z-index: 2000;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-panel.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ CES 2026 åœ°å›³æ©Ÿèƒ½ - Step 2</h1>
        <p>Venetian Expo, Level 1, Hall G</p>
    </div>
    
    <div class="controls">
        <div class="stats">
            <span class="stat-item">è¡¨ç¤ºä¼æ¥­æ•°: <strong id="companyCount">èª­è¾¼ä¸­...</strong></span>
            <span class="stat-item">åº§æ¨™: <strong id="coordInfo">-</strong></span>
        </div>
        <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” ä¼æ¥­åã§æ¤œç´¢...">
    </div>
    
    <div id="map"></div>
    
    <div class="loading" id="loading">
        <p>ğŸ“ åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">ãƒšãƒ¼ã‚¸11ã®ä¼æ¥­ã‚’è¡¨ç¤ºã—ã¾ã™</p>
    </div>
    
    <div class="debug-panel hidden" id="debugPanel">
        <div id="debugLog"></div>
    </div>

    <script>
    // ============================================
    // CES 2026 åœ°å›³æ©Ÿèƒ½ - Step 2
    // Leaflet.js + CSVåº§æ¨™ãƒ‡ãƒ¼ã‚¿
    // é«˜è§£åƒåº¦ç‰ˆï¼ˆ1200 DPIï¼‰
    // ============================================
    
    // å®šæ•°
    const CONFIG = {
        // ç”»åƒã‚µã‚¤ã‚ºï¼ˆ1200 DPI é«˜è§£åƒåº¦ç‰ˆï¼‰
        IMAGE_WIDTH: 13201,
        IMAGE_HEIGHT: 10200,
        
        // PDFåº§æ¨™ç³»ï¼ˆpdfplumberã§å–å¾—ï¼‰
        PDF_WIDTH: 792,
        PDF_HEIGHT: 612,
        
        // DPIè¨­å®š
        DPI: 1200,
        
        // å¯¾è±¡ãƒšãƒ¼ã‚¸
        TARGET_PAGE: 11,
        
        // ç”»åƒãƒ‘ã‚¹
        IMAGE_PATH: './page_11_1200dpi.png',
        
        // CSVãƒ‘ã‚¹
        CSV_PATH: './CES2026_æœ€çµ‚åº§æ¨™ãƒ‡ãƒ¼ã‚¿.csv'
    };
    
    // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
    // PDFåº§æ¨™ï¼ˆ792x612 ptï¼‰â†’ PNGåº§æ¨™ï¼ˆ13201x10200 pxï¼‰
    // å¤‰æ›ä¿‚æ•°: 1200 DPI / 72 pt = 16.667
    const PDF_TO_PNG_SCALE = CONFIG.DPI / 72;  // 16.667
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let map = null;
    let allCompanies = [];
    let filteredCompanies = [];
    let markers = [];
    let markerLayer = null;
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    function debugLog(msg) {
        console.log(msg);
        const logEl = document.getElementById('debugLog');
        if (logEl) {
            logEl.innerHTML += msg + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
        }
    }
    
    // CSVåº§æ¨™ï¼ˆPDFåº§æ¨™ 792x612åŸºæº–ï¼‰â†’ Leafletåº§æ¨™ã«å¤‰æ›
    function csvToLeaflet(pdfX, pdfY) {
        // PDFåº§æ¨™ã‚’PNGåº§æ¨™ã«å¤‰æ›ï¼ˆDPIå¤‰æ›ï¼‰
        const pngX = pdfX * PDF_TO_PNG_SCALE;
        const pngY = pdfY * PDF_TO_PNG_SCALE;
        
        // Yè»¸ã‚’åè»¢ï¼ˆLeaflet Simple CRSã¯å·¦ä¸ŠåŸç‚¹ã€PDFã¯å·¦ä¸‹åŸç‚¹ï¼‰
        const leafletLat = CONFIG.IMAGE_HEIGHT - pngY;
        const leafletLng = pngX;
        
        return [leafletLat, leafletLng];
    }
    
    // Leafletãƒãƒƒãƒ—ã®åˆæœŸåŒ–
    function initMap() {
        debugLog('Initializing Leaflet map...');
        
        // Simple CRSã§åˆæœŸåŒ–
        map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 4,
            zoomSnap: 0.25,
            zoomDelta: 0.5
        });
        
        // ç”»åƒã®å¢ƒç•Œã‚’è¨­å®š
        const bounds = [[0, 0], [CONFIG.IMAGE_HEIGHT, CONFIG.IMAGE_WIDTH]];
        
        // èƒŒæ™¯ç”»åƒã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        L.imageOverlay(CONFIG.IMAGE_PATH, bounds).addTo(map);
        
        // è¡¨ç¤ºç¯„å›²ã‚’ç”»åƒã«åˆã‚ã›ã‚‹
        map.fitBounds(bounds);
        
        // ãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
        markerLayer = L.layerGroup().addTo(map);
        
        // ãƒã‚¦ã‚¹ä½ç½®è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        map.on('mousemove', function(e) {
            const coordInfo = document.getElementById('coordInfo');
            if (coordInfo) {
                coordInfo.textContent = `lat: ${e.latlng.lat.toFixed(1)}, lng: ${e.latlng.lng.toFixed(1)}`;
            }
        });
        
        debugLog('Map initialized: ' + CONFIG.IMAGE_WIDTH + 'x' + CONFIG.IMAGE_HEIGHT);
    }
    
    // CSVãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadCSVData() {
        debugLog('Loading CSV data...');
        
        return new Promise((resolve, reject) => {
            Papa.parse(CONFIG.CSV_PATH, {
                download: true,
                header: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    debugLog('CSV loaded: ' + results.data.length + ' rows');
                    
                    // ãƒšãƒ¼ã‚¸11ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    const page11Data = results.data.filter(row => {
                        const page = parseFloat(row['PDFãƒšãƒ¼ã‚¸']);
                        return page === CONFIG.TARGET_PAGE;
                    });
                    
                    debugLog('Page 11 companies: ' + page11Data.length);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
                    const companies = page11Data.map(row => ({
                        name: row['ä¼šç¤¾å'] || '',
                        venue: row['ä¼šå ´'] || '',
                        booth: row['ãƒ–ãƒ¼ã‚¹ç•ªå·'] || '',
                        description: row['èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰'] || '',
                        bestOfInnovation: row['Best of Innovation'] === 'â˜…',
                        yamanakaWant: parseStars(row['å±±ä¸­è¡ŒããŸã„']),
                        nagasakaWant: parseStars(row['é•·å‚è¡ŒããŸã„']),
                        pdfPage: parseFloat(row['PDFãƒšãƒ¼ã‚¸']) || 0,
                        pdfX: parseFloat(row['PDF_X']) || 0,
                        pdfY: parseFloat(row['PDF_Y']) || 0,
                        source: row['åº§æ¨™ã‚½ãƒ¼ã‚¹'] || ''
                    })).filter(c => c.name && c.pdfX && c.pdfY);
                    
                    debugLog('Valid companies: ' + companies.length);
                    resolve(companies);
                },
                error: function(error) {
                    debugLog('CSV Error: ' + error.message);
                    reject(error);
                }
            });
        });
    }
    
    // â˜…ã®æ•°ã‚’ãƒ‘ãƒ¼ã‚¹
    function parseStars(value) {
        if (!value || value === 'NaN') return 0;
        if (value === 'â˜…â˜…') return 2;
        if (value === 'â˜…') return 1;
        return 0;
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
    function createMarkers(companies) {
        debugLog('Creating markers for ' + companies.length + ' companies');
        
        // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        markerLayer.clearLayers();
        markers = [];
        
        companies.forEach(company => {
            // CSVåº§æ¨™ã‚’Leafletåº§æ¨™ã«å¤‰æ›
            const [lat, lng] = csvToLeaflet(company.pdfX, company.pdfY);
            
            // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå††å½¢ï¼‰
            const icon = L.divIcon({
                className: 'custom-marker-wrapper',
                html: '<div class="custom-marker" style="width: 12px; height: 12px;"></div>',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
            const marker = L.marker([lat, lng], { icon: icon });
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹
            let popupContent = `
                <div class="popup-title">${escapeHtml(company.name)}</div>
                <div class="popup-info">ğŸ“ ${escapeHtml(company.venue)}</div>
                <span class="popup-booth">ãƒ–ãƒ¼ã‚¹ ${escapeHtml(company.booth)}</span>
            `;
            
            // ãƒãƒƒã‚¸è¿½åŠ 
            let badges = [];
            if (company.bestOfInnovation) badges.push('<span class="popup-badge best">ğŸ† Best of Innovation</span>');
            if (company.yamanakaWant === 2) badges.push('<span class="popup-badge yamanaka">â­â­å±±ä¸­</span>');
            else if (company.yamanakaWant === 1) badges.push('<span class="popup-badge yamanaka">â­å±±ä¸­</span>');
            if (company.nagasakaWant === 2) badges.push('<span class="popup-badge nagasaka">â­â­é•·å‚</span>');
            else if (company.nagasakaWant === 1) badges.push('<span class="popup-badge nagasaka">â­é•·å‚</span>');
            
            if (badges.length > 0) {
                popupContent += '<div class="popup-badges">' + badges.join('') + '</div>';
            }
            
            marker.bindPopup(popupContent);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ç´ä»˜ã‘
            marker.companyData = company;
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 
            markerLayer.addLayer(marker);
            markers.push(marker);
        });
        
        // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        document.getElementById('companyCount').textContent = companies.length + 'ç¤¾';
        
        debugLog('Markers created: ' + markers.length);
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    function filterCompanies(query) {
        if (!query) {
            filteredCompanies = [...allCompanies];
        } else {
            const lowerQuery = query.toLowerCase();
            filteredCompanies = allCompanies.filter(c => 
                c.name.toLowerCase().includes(lowerQuery) ||
                c.booth.toLowerCase().includes(lowerQuery)
            );
        }
        
        createMarkers(filteredCompanies);
    }
    
    // åˆæœŸåŒ–
    async function init() {
        debugLog('=== Step 2 Initialization (1200 DPI) ===');
        
        try {
            // ãƒãƒƒãƒ—åˆæœŸåŒ–
            initMap();
            
            // CSVãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            allCompanies = await loadCSVData();
            filteredCompanies = [...allCompanies];
            
            // ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
            createMarkers(filteredCompanies);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            document.getElementById('loading').classList.add('hidden');
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('searchBox').addEventListener('input', function(e) {
                filterCompanies(e.target.value);
            });
            
            debugLog('=== Initialization Complete ===');
            
        } catch (error) {
            debugLog('ERROR: ' + error.message);
            document.getElementById('loading').innerHTML = 
                '<p style="color: red;">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>' +
                '<p style="font-size: 0.8rem;">' + error.message + '</p>';
        }
    }
    
    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
